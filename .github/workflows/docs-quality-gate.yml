name: docs-quality-gate

on:
  pull_request:
  push:
    branches:
      - master
      - main

jobs:
  docs-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run docs gates
        shell: bash
        run: |
          set -euo pipefail
          REPO_ROOT="$GITHUB_WORKSPACE"
          PYTHON_BIN="${PYTHON_BIN:-python3}"
          command -v "$PYTHON_BIN" >/dev/null || { echo "python not found: $PYTHON_BIN" >&2; exit 2; }
          CODEX_HOME_RESOLVED="${CODEX_HOME:-$HOME/.codex}"
          if [ -n "${SKILL_DIR:-}" ]; then
            [ -d "$SKILL_DIR/scripts" ] || {
              echo "invalid SKILL_DIR: $SKILL_DIR (expected scripts/ under this path)" >&2
              exit 2
            }
          elif [ -d "$REPO_ROOT/.agents/skills/docs-sor-maintainer/scripts" ]; then
            SKILL_DIR="$REPO_ROOT/.agents/skills/docs-sor-maintainer"
          elif [ -d "$REPO_ROOT/skills/docs-sor-maintainer/scripts" ]; then
            SKILL_DIR="$REPO_ROOT/skills/docs-sor-maintainer"
          elif [ -d "$CODEX_HOME_RESOLVED/skills/docs-sor-maintainer/scripts" ]; then
            SKILL_DIR="$CODEX_HOME_RESOLVED/skills/docs-sor-maintainer"
          else
            echo "docs-sor-maintainer not found. Set SKILL_DIR or install under .agents/skills, skills or \$HOME/.codex/skills." >&2
            exit 2
          fi
          "$PYTHON_BIN" "$SKILL_DIR/scripts/repo_scan.py" --root "$REPO_ROOT" --output "$REPO_ROOT/docs/.repo-facts.json"
          "$PYTHON_BIN" "$SKILL_DIR/scripts/doc_plan.py" --root "$REPO_ROOT" --mode audit --facts "$REPO_ROOT/docs/.repo-facts.json" --output "$REPO_ROOT/docs/.doc-plan.json"
          "$PYTHON_BIN" "$SKILL_DIR/scripts/doc_synthesize.py" --root "$REPO_ROOT" --plan "$REPO_ROOT/docs/.doc-plan.json" --facts "$REPO_ROOT/docs/.repo-facts.json" --output "$REPO_ROOT/docs/.doc-evidence-map.json"
          "$PYTHON_BIN" "$SKILL_DIR/scripts/doc_validate.py" --root "$REPO_ROOT" --facts "$REPO_ROOT/docs/.repo-facts.json" --fail-on-drift --fail-on-freshness --output "$REPO_ROOT/docs/.doc-validate-report.json"
          "$PYTHON_BIN" -m unittest discover -s "$REPO_ROOT/skills/docs-sor-maintainer/tests" -p "test_*.py"
